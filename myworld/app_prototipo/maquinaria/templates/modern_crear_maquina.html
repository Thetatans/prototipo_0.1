<!-- templates/maquinaria/modern_crear_maquina.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Registrar Nueva M√°quina - SENA{% endblock %}

{% block extra_css %}
<style>
    .form-wizard {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .wizard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
    }
    
    .wizard-title {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .wizard-subtitle {
        opacity: 0.9;
        margin-bottom: 0;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin: 2rem 0;
        padding: 0 2rem;
    }
    
    .step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        background: #f8f9fa;
        color: #6c757d;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .step.active {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        transform: scale(1.05);
    }
    
    .step.completed {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: white;
    }
    
    .step-number {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .step.active .step-number {
        background: rgba(255,255,255,0.3);
    }
    
    .step-content {
        padding: 2rem;
        min-height: 400px;
    }
    
    .form-section {
        display: none;
    }
    
    .form-section.active {
        display: block;
        animation: fadeInUp 0.4s ease;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .required-indicator {
        color: #dc3545;
        font-size: 0.8rem;
    }
    
    .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15);
        outline: none;
    }
    
    .form-control.is-invalid {
        border-color: #dc3545;
    }
    
    .form-control.is-valid {
        border-color: #28a745;
    }
    
    .input-icon {
        position: relative;
    }
    
    .input-icon i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 1.1rem;
    }
    
    .input-icon .form-control {
        padding-left: 3rem;
    }
    
    .form-help {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .character-counter {
        font-size: 0.8rem;
        color: #6c757d;
        text-align: right;
        margin-top: 0.25rem;
    }
    
    .character-counter.warning {
        color: #ffc107;
    }
    
    .character-counter.danger {
        color: #dc3545;
    }
    
    .file-upload-zone {
        border: 2px dashed #e9ecef;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        background: #fafafa;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .file-upload-zone:hover {
        border-color: #007bff;
        background: #f0f8ff;
    }
    
    .file-upload-zone.dragover {
        border-color: #007bff;
        background: #e3f2fd;
        transform: scale(1.02);
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #007bff;
        margin-bottom: 1rem;
    }
    
    .upload-text {
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .upload-hint {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .preview-image {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .wizard-navigation {
        padding: 1.5rem 2rem;
        background: #f8f9fa;
        display: flex;
        justify-content: between;
        gap: 1rem;
    }
    
    .btn-wizard {
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s ease;
        border: none;
    }
    
    .btn-wizard:hover {
        transform: translateY(-1px);
    }
    
    .btn-previous {
        background: #6c757d;
        color: white;
    }
    
    .btn-previous:hover {
        background: #5a6268;
    }
    
    .btn-next {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
    }
    
    .btn-next:hover {
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: white;
    }
    
    .btn-submit:hover {
        box-shadow: 0 4px 12px rgba(40,167,69,0.3);
    }
    
    .validation-summary {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .validation-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0;
        font-size: 0.9rem;
    }
    
    .validation-item.valid {
        color: #28a745;
    }
    
    .validation-item.invalid {
        color: #dc3545;
    }
    
    .progress-bar-container {
        background: #e9ecef;
        border-radius: 10px;
        height: 6px;
        margin: 1rem 0;
        overflow: hidden;
    }
    
    .progress-bar {
        background: linear-gradient(135deg, #007bff, #0056b3);
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .summary-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .summary-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .summary-content {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .floating-save {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        opacity: 0;
        transform: scale(0);
        transition: all 0.3s ease;
    }
    
    .floating-save.show {
        opacity: 1;
        transform: scale(1);
    }
    
    .smart-suggestions {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    
    .suggestion-item {
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 4px;
        margin: 0.25rem 0;
        transition: background 0.2s ease;
    }
    
    .suggestion-item:hover {
        background: #bbdefb;
    }
    
    @media (max-width: 768px) {
        .step-indicator {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .step {
            width: 100%;
            justify-content: center;
        }
        
        .step-content {
            padding: 1rem;
        }
        
        .wizard-navigation {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'maquinaria:dashboard' %}">Maquinaria</a></li>
<li class="breadcrumb-item"><a href="{% url 'maquinaria:lista_maquinas' %}">Inventario</a></li>
<li class="breadcrumb-item active">Nueva M√°quina</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <div class="form-wizard">
                <!-- Header -->
                <div class="wizard-header">
                    <div class="wizard-title">üè≠ Registrar Nueva M√°quina</div>
                    <div class="wizard-subtitle">Complete la informaci√≥n en 4 sencillos pasos</div>
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 25%;"></div>
                    </div>
                </div>
                
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <span>Informaci√≥n B√°sica</span>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <span>Especificaciones</span>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <span>Ubicaci√≥n y Compra</span>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <span>Resumen y Confirmaci√≥n</span>
                    </div>
                </div>
                
                <!-- Form Content -->
                <form id="machineForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Step 1: Informaci√≥n B√°sica -->
                    <div class="step-content">
                        <div class="form-section active" data-section="1">
                            <h4 class="mb-4">üìã Informaci√≥n B√°sica de la M√°quina</h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-upc-scan"></i>
                                            C√≥digo de Inventario
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <div class="input-icon">
                                            <i class="bi bi-hash"></i>
                                            <input type="text" name="codigo_inventario" class="form-control" 
                                                   placeholder="Ej: TOR-001" required id="codigoInput" maxlength="20">
                                        </div>
                                        <div class="form-help">
                                            <i class="bi bi-info-circle"></i>
                                            C√≥digo √∫nico para identificar la m√°quina
                                        </div>
                                        <div class="character-counter" id="codigoCounter">0/20</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-gear"></i>
                                            Nombre de la M√°quina
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <input type="text" name="nombre" class="form-control" 
                                               placeholder="Ej: Torno CNC Siemens 840D" required id="nombreInput">
                                        <div class="form-help">
                                            <i class="bi bi-lightbulb"></i>
                                            Nombre descriptivo y completo
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-folder"></i>
                                            Categor√≠a
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <select name="categoria" class="form-control" required id="categoriaSelect">
                                            <option value="">Seleccionar categor√≠a...</option>
                                            <!-- Las opciones se cargar√°n din√°micamente -->
                                        </select>
                                        <div class="form-help">
                                            <i class="bi bi-tag"></i>
                                            Tipo de m√°quina o equipo
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-toggle-on"></i>
                                            Estado Inicial
                                        </label>
                                        <select name="estado" class="form-control" id="estadoSelect">
                                            <option value="disponible" selected>Disponible</option>
                                            <option value="operativa">Operativa</option>
                                            <option value="mantenimiento">En Mantenimiento</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-building"></i>
                                            Marca
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <input type="text" name="marca" class="form-control" 
                                               placeholder="Ej: Siemens" required id="marcaInput">
                                        <div id="marcaSuggestions" class="smart-suggestions" style="display: none;">
                                            <div class="suggestion-item" onclick="selectSuggestion('marca', 'Siemens')">Siemens</div>
                                            <div class="suggestion-item" onclick="selectSuggestion('marca', 'Fanuc')">Fanuc</div>
                                            <div class="suggestion-item" onclick="selectSuggestion('marca', 'Haas')">Haas</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-cpu"></i>
                                            Modelo
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <input type="text" name="modelo" class="form-control" 
                                               placeholder="Ej: 840D sl" required>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-123"></i>
                                            N√∫mero de Serie
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <input type="text" name="numero_serie" class="form-control" 
                                               placeholder="Ej: SN123456789" required>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="bi bi-camera"></i>
                                    Imagen de la M√°quina
                                </label>
                                <div class="file-upload-zone" onclick="document.getElementById('imageInput').click()">
                                    <div class="upload-icon">
                                        <i class="bi bi-cloud-upload"></i>
                                    </div>
                                    <div class="upload-text">Arrastra una imagen aqu√≠ o haz clic para seleccionar</div>
                                    <div class="upload-hint">Formatos: JPG, PNG, GIF (m√°x. 5MB)</div>
                                </div>
                                <input type="file" name="imagen" id="imageInput" accept="image/*" style="display: none;">
                                <img id="imagePreview" class="preview-image" style="display: none;">
                            </div>
                        </div>
                        
                        <!-- Step 2: Especificaciones -->
                        <div class="form-section" data-section="2">
                            <h4 class="mb-4">‚öôÔ∏è Especificaciones T√©cnicas</h4>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="bi bi-file-text"></i>
                                    Especificaciones T√©cnicas Generales
                                </label>
                                <textarea name="especificaciones_tecnicas" class="form-control" rows="4"
                                          placeholder="Describa las caracter√≠sticas t√©cnicas principales de la m√°quina..."></textarea>
                                <div class="character-counter" id="especCounter">0/1000</div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-speedometer2"></i>
                                            Capacidad
                                        </label>
                                        <input type="text" name="capacidad" class="form-control" 
                                               placeholder="Ej: 400mm volteo x 1000mm">
                                        <div class="form-help">
                                            <i class="bi bi-ruler"></i>
                                            Capacidad de trabajo o dimensiones m√°ximas
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-lightning"></i>
                                            Potencia
                                        </label>
                                        <input type="text" name="potencia" class="form-control" 
                                               placeholder="Ej: 15 kW">
                                        <div class="form-help">
                                            <i class="bi bi-plug"></i>
                                            Potencia el√©ctrica o mec√°nica
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-outlet"></i>
                                            Voltaje
                                        </label>
                                        <input type="text" name="voltaje" class="form-control" 
                                               placeholder="Ej: 380V">
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-arrows-expand"></i>
                                            Dimensiones
                                        </label>
                                        <input type="text" name="dimensiones" class="form-control" 
                                               placeholder="Ej: 2000x1500x1800mm">
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-weight"></i>
                                            Peso
                                        </label>
                                        <input type="text" name="peso" class="form-control" 
                                               placeholder="Ej: 3500 kg">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Ubicaci√≥n y Compra -->
                        <div class="form-section" data-section="3">
                            <h4 class="mb-4">üìç Ubicaci√≥n y Informaci√≥n de Compra</h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-geo-alt"></i>
                                            Ubicaci√≥n F√≠sica
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <input type="text" name="ubicacion" class="form-control" 
                                               placeholder="Ej: Taller de Mecanizado - Zona A" required>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-person-check"></i>
                                            Responsable
                                        </label>
                                        <select name="responsable" class="form-control">
                                            <option value="">Sin asignar...</option>
                                            <!-- Opciones de usuarios se cargar√°n din√°micamente -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-building"></i>
                                            Centro de Formaci√≥n
                                        </label>
                                        <input type="text" name="centro_formacion" class="form-control" 
                                               placeholder="Ej: Centro Tecnol√≥gico Industrial"
                                               value="{{ user.centro_formacion }}">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-door-open"></i>
                                            Ambiente de Formaci√≥n
                                        </label>
                                        <input type="text" name="ambiente_formacion" class="form-control" 
                                               placeholder="Ej: Ambiente CNC">
                                    </div>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            <h5>üí∞ Informaci√≥n de Compra</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-shop"></i>
                                            Proveedor
                                        </label>
                                        <select name="proveedor" class="form-control">
                                            <option value="">Seleccionar proveedor...</option>
                                            <!-- Opciones de proveedores se cargar√°n din√°micamente -->
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-calendar"></i>
                                            Fecha de Adquisici√≥n
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <input type="date" name="fecha_adquisicion" class="form-control" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-currency-dollar"></i>
                                            Valor de Adquisici√≥n (COP)
                                            <span class="required-indicator">*</span>
                                        </label>
                                        <input type="number" name="valor_adquisicion" class="form-control" 
                                               placeholder="Ej: 120000000" required id="valorInput">
                                        <div class="form-help" id="valorHelp">
                                            <i class="bi bi-calculator"></i>
                                            Valor en pesos colombianos
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-receipt"></i>
                                            N√∫mero de Factura
                                        </label>
                                        <input type="text" name="numero_factura" class="form-control" 
                                               placeholder="Ej: F-2024-001">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 4: Resumen -->
                        <div class="form-section" data-section="4">
                            <h4 class="mb-4">üìã Resumen y Confirmaci√≥n</h4>
                            
                            <div class="validation-summary">
                                <h6>‚úÖ Validaci√≥n de Datos</h6>
                                <div class="validation-item invalid" id="validationCodigo">
                                    <i class="bi bi-x-circle"></i>
                                    C√≥digo de inventario requerido
                                </div>
                                <div class="validation-item invalid" id="validationNombre">
                                    <i class="bi bi-x-circle"></i>
                                    Nombre de m√°quina requerido
                                </div>
                                <div class="validation-item invalid" id="validationCategoria">
                                    <i class="bi bi-x-circle"></i>
                                    Categor√≠a requerida
                                </div>
                                <div class="validation-item invalid" id="validationFecha">
                                    <i class="bi bi-x-circle"></i>
                                    Fecha de adquisici√≥n requerida
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="summary-card">
                                        <div class="summary-title">üìã Informaci√≥n B√°sica</div>
                                        <div class="summary-content" id="summaryBasica">
                                            <!-- Se llenar√° din√°micamente -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="summary-card">
                                        <div class="summary-title">‚öôÔ∏è Especificaciones</div>
                                        <div class="summary-content" id="summaryEspec">
                                            <!-- Se llenar√° din√°micamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="summary-card">
                                        <div class="summary-title">üìç Ubicaci√≥n</div>
                                        <div class="summary-content" id="summaryUbicacion">
                                            <!-- Se llenar√° din√°micamente -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="summary-card">
                                        <div class="summary-title">üí∞ Compra</div>
                                        <div class="summary-content" id="summaryCompra">
                                            <!-- Se llenar√° din√°micamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="bi bi-chat-text"></i>
                                    Observaciones Adicionales
                                </label>
                                <textarea name="observaciones" class="form-control" rows="3"
                                          placeholder="Cualquier informaci√≥n adicional importante..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="wizard-navigation">
                        <button type="button" class="btn btn-wizard btn-previous" onclick="previousStep()" style="display: none;">
                            <i class="bi bi-arrow-left me-2"></i>Anterior
                        </button>
                        
                        <div class="ms-auto d-flex gap-2">
                            <button type="button" class="btn btn-wizard btn-next" onclick="nextStep()">
                                Siguiente<i class="bi bi-arrow-right ms-2"></i>
                            </button>
                            <button type="submit" class="btn btn-wizard btn-submit" style="display: none;">
                                <i class="bi bi-check-lg me-2"></i>Registrar M√°quina
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Floating Save Button -->
<button class="floating-save" id="floatingSave" title="Guardar borrador">
    <i class="bi bi-save"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
const totalSteps = 4;
let formData = {};

document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    setupEventListeners();
    loadDraft();
});

function initializeForm() {
    // Cargar datos din√°micos
    loadCategories();
    loadProviders();
    loadUsers();
    
    // Configurar validaci√≥n en tiempo real
    setupRealTimeValidation();
    
    // Configurar subida de imagen
    setupImageUpload();
}

function setupEventListeners() {
    // Character counters
    document.getElementById('codigoInput').addEventListener('input', function() {
        updateCharacterCounter('codigoCounter', this.value.length, 20);
    });
    
    document.querySelector('[name="especificaciones_tecnicas"]').addEventListener('input', function() {
        updateCharacterCounter('especCounter', this.value.length, 1000);
    });
    
    // Smart suggestions
    document.getElementById('marcaInput').addEventListener('focus', function() {
        document.getElementById('marcaSuggestions').style.display = 'block';
    });
    
    document.getElementById('marcaInput').addEventListener('blur', function() {
        setTimeout(() => {
            document.getElementById('marcaSuggestions').style.display = 'none';
        }, 200);
    });
    
    // Valor formatting
    document.getElementById('valorInput').addEventListener('input', function() {
        formatCurrency(this);
    });
    
    // Auto-save draft
    const formInputs = document.querySelectorAll('#machineForm input, #machineForm select, #machineForm textarea');
    formInputs.forEach(input => {
        input.addEventListener('input', saveDraft);
    });
}

function updateCharacterCounter(counterId, current, max) {
    const counter = document.getElementById(counterId);
    counter.textContent = `${current}/${max}`;
    
    if (current > max * 0.9) {
        counter.className = 'character-counter danger';
    } else if (current > max * 0.7) {
        counter.className = 'character-counter warning';
    } else {
        counter.className = 'character-counter';
    }
}

function formatCurrency(input) {
    let value = input.value.replace(/\D/g, '');
    if (value) {
        value = parseInt(value).toLocaleString('es-CO');
        document.getElementById('valorHelp').innerHTML = `
            <i class="bi bi-calculator"></i>
            $${value} COP
        `;
    }
}

function selectSuggestion(field, value) {
    document.querySelector(`[name="${field}"]`).value = value;
    document.getElementById(`${field}Suggestions`).style.display = 'none';
}

function setupImageUpload() {
    const uploadZone = document.querySelector('.file-upload-zone');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    
    // Drag and drop
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
            imageInput.files = files;
            previewImage(files[0]);
        }
    });
    
    imageInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            previewImage(this.files[0]);
        }
    });
}

function previewImage(file) {
    const reader = new FileReader();
    const preview = document.getElementById('imagePreview');
    
    reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
    };
    
    reader.readAsDataURL(file);
}

function nextStep() {
    if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
            currentStep++;
            updateStep();
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStep();
    }
}

function updateStep() {
    // Update step indicator
    document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < currentStep) {
            step.classList.add('completed');
        } else if (index + 1 === currentStep) {
            step.classList.add('active');
        }
    });
    
    // Update form sections
    document.querySelectorAll('.form-section').forEach((section, index) => {
        section.classList.remove('active');
        if (index + 1 === currentStep) {
            section.classList.add('active');
        }
    });
    
    // Update navigation buttons
    const prevBtn = document.querySelector('.btn-previous');
    const nextBtn = document.querySelector('.btn-next');
    const submitBtn = document.querySelector('.btn-submit');
    
    prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
    
    if (currentStep === totalSteps) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'block';
        updateSummary();
    } else {
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
    }
    
    // Update progress bar
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

function validateCurrentStep() {
    const currentSection = document.querySelector(`.form-section[data-section="${currentStep}"]`);
    const requiredInputs = currentSection.querySelectorAll('[required]');
    let isValid = true;
    
    requiredInputs.forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('is-invalid');
            isValid = false;
        } else {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
        }
    });
    
    return isValid;
}

function updateSummary() {
    const form = document.getElementById('machineForm');
    const formData = new FormData(form);
    
    // Informaci√≥n b√°sica
    document.getElementById('summaryBasica').innerHTML = `
        <strong>C√≥digo:</strong> ${formData.get('codigo_inventario') || 'No especificado'}<br>
        <strong>Nombre:</strong> ${formData.get('nombre') || 'No especificado'}<br>
        <strong>Marca:</strong> ${formData.get('marca') || 'No especificado'}<br>
        <strong>Modelo:</strong> ${formData.get('modelo') || 'No especificado'}
    `;
    
    // Especificaciones
    document.getElementById('summaryEspec').innerHTML = `
        <strong>Potencia:</strong> ${formData.get('potencia') || 'No especificado'}<br>
        <strong>Capacidad:</strong> ${formData.get('capacidad') || 'No especificado'}<br>
        <strong>Voltaje:</strong> ${formData.get('voltaje') || 'No especificado'}<br>
        <strong>Peso:</strong> ${formData.get('peso') || 'No especificado'}
    `;
    
    // Ubicaci√≥n
    document.getElementById('summaryUbicacion').innerHTML = `
        <strong>Ubicaci√≥n:</strong> ${formData.get('ubicacion') || 'No especificado'}<br>
        <strong>Centro:</strong> ${formData.get('centro_formacion') || 'No especificado'}<br>
        <strong>Ambiente:</strong> ${formData.get('ambiente_formacion') || 'No especificado'}
    `;
    
    // Compra
    const valor = formData.get('valor_adquisicion');
    const valorFormatted = valor ? parseInt(valor).toLocaleString('es-CO') : 'No especificado';
    
    document.getElementById('summaryCompra').innerHTML = `
        <strong>Fecha:</strong> ${formData.get('fecha_adquisicion') || 'No especificado'}<br>
        <strong>Valor:</strong> $${valorFormatted} COP<br>
        <strong>Factura:</strong> ${formData.get('numero_factura') || 'No especificado'}
    `;
    
    // Update validation items
    updateValidationItems();
}

function updateValidationItems() {
    const form = document.getElementById('machineForm');
    const formData = new FormData(form);
    
    const validations = [
        { id: 'validationCodigo', field: 'codigo_inventario', label: 'C√≥digo de inventario' },
        { id: 'validationNombre', field: 'nombre', label: 'Nombre de m√°quina' },
        { id: 'validationCategoria', field: 'categoria', label: 'Categor√≠a' },
        { id: 'validationFecha', field: 'fecha_adquisicion', label: 'Fecha de adquisici√≥n' }
    ];
    
    validations.forEach(validation => {
        const element = document.getElementById(validation.id);
        const value = formData.get(validation.field);
        
        if (value && value.trim()) {
            element.className = 'validation-item valid';
            element.innerHTML = `<i class="bi bi-check-circle"></i> ${validation.label} completado`;
        } else {
            element.className = 'validation-item invalid';
            element.innerHTML = `<i class="bi bi-x-circle"></i> ${validation.label} requerido`;
        }
    });
}

function saveDraft() {
    const form = document.getElementById('machineForm');
    const formData = new FormData(form);
    const draftData = {};
    
    for (let [key, value] of formData.entries()) {
        draftData[key] = value;
    }
    
    localStorage.setItem('machineDraft', JSON.stringify(draftData));
    
    // Show floating save button
    const floatingSave = document.getElementById('floatingSave');
    floatingSave.classList.add('show');
    
    setTimeout(() => {
        floatingSave.classList.remove('show');
    }, 2000);
}

function loadDraft() {
    const draft = localStorage.getItem('machineDraft');
    if (draft) {
        const draftData = JSON.parse(draft);
        
        Object.keys(draftData).forEach(key => {
            const input = document.querySelector(`[name="${key}"]`);
            if (input && draftData[key]) {
                input.value = draftData[key];
            }
        });
    }
}

function loadCategories() {
    // Simular carga de categor√≠as
    const categories = [
        'Tornos CNC',
        'Fresadoras',
        'Taladros',
        'Soldadura',
        'Neum√°tica',
        'Hidr√°ulica'
    ];
    
    const select = document.querySelector('[name="categoria"]');
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.toLowerCase().replace(' ', '_');
        option.textContent = cat;
        select.appendChild(option);
    });
}

function loadProviders() {
    // Simular carga de proveedores
    const providers = [
        'Siemens Colombia',
        'Schneider Electric',
        'SKF Colombia',
        'Fanuc Colombia'
    ];
    
    const select = document.querySelector('[name="proveedor"]');
    providers.forEach(prov => {
        const option = document.createElement('option');
        option.value = prov.toLowerCase().replace(' ', '_');
        option.textContent = prov;
        select.appendChild(option);
    });
}

function loadUsers() {
    // Simular carga de usuarios responsables
    const users = [
        'Carlos Rodr√≠guez',
        'Mar√≠a Garc√≠a',
        'Luis Mart√≠nez'
    ];
    
    const select = document.querySelector('[name="responsable"]');
    users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.toLowerCase().replace(' ', '_');
        option.textContent = user;
        select.appendChild(option);
    });
}

function setupRealTimeValidation() {
    const form = document.getElementById('machineForm');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateCurrentStep()) {
            // Show loading state
            const submitBtn = document.querySelector('.btn-submit');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Registrando...';
            submitBtn.disabled = true;
            
            // Simulate form submission
            setTimeout(() => {
                // Clear draft
                localStorage.removeItem('machineDraft');
                
                // Show success message
                alert('‚úÖ M√°quina registrada exitosamente!');
                
                // Redirect or reset form
                window.location.href = '/maquinaria/lista/';
            }, 2000);
        }
    });
}

// Handle floating save button click
document.getElementById('floatingSave').addEventListener('click', function() {
    saveDraft();
    
    // Show feedback
    this.innerHTML = '<i class="bi bi-check"></i>';
    setTimeout(() => {
        this.innerHTML = '<i class="bi bi-save"></i>';
    }, 1000);
});
</script>
{% endblock %}