<!-- templates/reportes/visual_dashboard.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Reportes y An치lisis - SENA{% endblock %}

{% block extra_css %}
<style>
    .reports-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin: -1.5rem -1.5rem 2rem;
        border-radius: 0 0 20px 20px;
        position: relative;
        overflow: hidden;
    }
    
    .reports-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        transform: rotate(45deg);
    }
    
    .header-content {
        position: relative;
        z-index: 2;
    }
    
    .report-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid #f0f0f0;
        height: 100%;
    }
    
    .report-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    
    .report-card-header {
        padding: 1.5rem;
        border-bottom: 1px solid #f8f9fa;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .report-title {
        font-weight: 600;
        color: #212529;
        margin: 0;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .report-subtitle {
        color: #6c757d;
        font-size: 0.85rem;
        margin: 0.25rem 0 0;
    }
    
    .report-card-body {
        padding: 1.5rem;
        position: relative;
        min-height: 300px;
    }
    
    .chart-container {
        position: relative;
        height: 250px;
        width: 100%;
    }
    
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .kpi-card {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border-left: 4px solid;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, rgba(0,0,0,0.05), transparent);
        border-radius: 50%;
        transform: translate(30%, -30%);
    }
    
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(0,0,0,0.1);
    }
    
    .kpi-efficiency {
        border-left-color: #28a745;
    }
    
    .kpi-cost {
        border-left-color: #17a2b8;
    }
    
    .kpi-downtime {
        border-left-color: #ffc107;
    }
    
    .kpi-satisfaction {
        border-left-color: #007bff;
    }
    
    .kpi-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        margin: 0 auto 1rem;
        color: white;
        position: relative;
        z-index: 2;
    }
    
    .kpi-efficiency .kpi-icon {
        background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .kpi-cost .kpi-icon {
        background: linear-gradient(135deg, #17a2b8, #138496);
    }
    
    .kpi-downtime .kpi-icon {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
    }
    
    .kpi-satisfaction .kpi-icon {
        background: linear-gradient(135deg, #007bff, #0056b3);
    }
    
    .kpi-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #212529;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 2;
    }
    
    .kpi-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
        position: relative;
        z-index: 2;
    }
    
    .kpi-trend {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        margin-top: 0.5rem;
        font-size: 0.8rem;
        position: relative;
        z-index: 2;
    }
    
    .trend-up {
        color: #28a745;
    }
    
    .trend-down {
        color: #dc3545;
    }
    
    .trend-stable {
        color: #6c757d;
    }
    
    .filter-panel {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }
    
    .filter-row {
        display: flex;
        gap: 1rem;
        align-items: end;
        flex-wrap: wrap;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-label {
        display: block;
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .filter-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }
    
    .filter-control:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    .export-dropdown {
        position: relative;
    }
    
    .export-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .export-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40,167,69,0.3);
    }
    
    .export-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 150px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    .export-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .export-menu-item {
        display: block;
        padding: 0.5rem 1rem;
        color: #495057;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
    }
    
    .export-menu-item:hover {
        background: #f8f9fa;
        color: #007bff;
    }
    
    .progress-ring-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        position: relative;
    }
    
    .progress-ring {
        width: 150px;
        height: 150px;
        transform: rotate(-90deg);
    }
    
    .progress-ring circle {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
    }
    
    .progress-ring .background {
        stroke: #e9ecef;
    }
    
    .progress-ring .progress {
        stroke-dasharray: 440;
        stroke-dashoffset: 440;
        transition: stroke-dashoffset 1s ease;
    }
    
    .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    .progress-value {
        font-size: 2rem;
        font-weight: 700;
        color: #212529;
    }
    
    .progress-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .data-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .table-header {
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .table-title {
        font-weight: 600;
        margin: 0;
        color: #212529;
    }
    
    .table-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .modern-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .modern-table th {
        background: #f8f9fa;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 1px solid #e9ecef;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .modern-table td {
        padding: 1rem;
        border-bottom: 1px solid #f8f9fa;
        color: #495057;
    }
    
    .modern-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-success {
        background: #28a745;
    }
    
    .status-warning {
        background: #ffc107;
    }
    
    .status-danger {
        background: #dc3545;
    }
    
    .sparkline {
        width: 60px;
        height: 30px;
    }
    
    .real-time-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #28a745;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .pulse-dot {
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.2);
            opacity: 0.7;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .insight-card {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border: 1px solid #e1f5fe;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
    }
    
    .insight-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(to bottom, #2196f3, #9c27b0);
    }
    
    .insight-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2196f3, #9c27b0);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-bottom: 1rem;
    }
    
    .insight-title {
        font-weight: 600;
        color: #1565c0;
        margin-bottom: 0.5rem;
    }
    
    .insight-text {
        color: #424242;
        line-height: 1.5;
    }
    
    @media (max-width: 768px) {
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .kpi-card {
            padding: 1.5rem;
        }
        
        .kpi-value {
            font-size: 2rem;
        }
        
        .filter-row {
            flex-direction: column;
        }
        
        .filter-group {
            min-width: 100%;
        }
        
        .report-card-body {
            padding: 1rem;
        }
        
        .chart-container {
            height: 200px;
        }
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Reportes y An치lisis</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="reports-header">
    <div class="container-fluid">
        <div class="header-content">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="mb-2">游늵 Reportes y An치lisis</h1>
                    <p class="mb-0 opacity-75">Inteligencia de negocio para optimizar operaciones</p>
                    <div class="real-time-indicator mt-2">
                        <span class="pulse-dot"></span>
                        Datos en tiempo real
                    </div>
                </div>
                <div class="col-lg-4 text-end">
                    <div class="export-dropdown">
                        <button class="export-btn" onclick="toggleExportMenu()">
                            <i class="bi bi-download"></i>
                            Exportar Reportes
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="export-menu" id="exportMenu">
                            <button class="export-menu-item" onclick="exportReport('pdf')">
                                <i class="bi bi-file-earmark-pdf me-2"></i>PDF
                            </button>
                            <button class="export-menu-item" onclick="exportReport('excel')">
                                <i class="bi bi-file-earmark-excel me-2"></i>Excel
                            </button>
                            <button class="export-menu-item" onclick="exportReport('csv')">
                                <i class="bi bi-file-earmark-text me-2"></i>CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="filter-panel">
    <div class="filter-row">
        <div class="filter-group">
            <label class="filter-label">游늰 Per칤odo</label>
            <select class="filter-control" id="periodFilter">
                <option value="last-7-days">칔ltimos 7 d칤as</option>
                <option value="last-30-days" selected>칔ltimos 30 d칤as</option>
                <option value="last-3-months">칔ltimos 3 meses</option>
                <option value="last-year">칔ltimo a침o</option>
                <option value="custom">Personalizado</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">游낈 Centro de Formaci칩n</label>
            <select class="filter-control" id="centerFilter">
                <option value="all">Todos los centros</option>
                <option value="industrial">Centro Tecnol칩gico Industrial</option>
                <option value="automatizacion">Centro de Automatizaci칩n</option>
                <option value="manufactura">Centro de Manufactura</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">游댢 Categor칤a</label>
            <select class="filter-control" id="categoryFilter">
                <option value="all">Todas las categor칤as</option>
                <option value="cnc">Tornos CNC</option>
                <option value="fresadoras">Fresadoras</option>
                <option value="soldadura">Soldadura</option>
                <option value="neumatica">Neum치tica</option>
            </select>
        </div>
        
        <div class="filter-group">
            <button class="export-btn" onclick="applyFilters()">
                <i class="bi bi-funnel"></i>
                Aplicar Filtros
            </button>
        </div>
    </div>
</div>

<!-- KPIs Principales -->
<div class="kpi-grid">
    <div class="kpi-card kpi-efficiency">
        <div class="kpi-icon">
            <i class="bi bi-graph-up-arrow"></i>
        </div>
        <div class="kpi-value" id="efficiencyValue">87.5%</div>
        <div class="kpi-label">Eficiencia Global</div>
        <div class="kpi-trend trend-up">
            <i class="bi bi-arrow-up"></i>
            +2.3% vs mes anterior
        </div>
    </div>
    
    <div class="kpi-card kpi-cost">
        <div class="kpi-icon">
            <i class="bi bi-currency-dollar"></i>
        </div>
        <div class="kpi-value" id="costValue">$2.4M</div>
        <div class="kpi-label">Costo de Mantenimiento</div>
        <div class="kpi-trend trend-down">
            <i class="bi bi-arrow-down"></i>
            -5.1% vs mes anterior
        </div>
    </div>
    
    <div class="kpi-card kpi-downtime">
        <div class="kpi-icon">
            <i class="bi bi-clock"></i>
        </div>
        <div class="kpi-value" id="downtimeValue">2.1h</div>
        <div class="kpi-label">Tiempo Fuera Promedio</div>
        <div class="kpi-trend trend-stable">
            <i class="bi bi-dash"></i>
            Sin cambios
        </div>
    </div>
    
    <div class="kpi-card kpi-satisfaction">
        <div class="kpi-icon">
            <i class="bi bi-emoji-smile"></i>
        </div>
        <div class="kpi-value" id="satisfactionValue">94.2%</div>
        <div class="kpi-label">Satisfacci칩n Usuario</div>
        <div class="kpi-trend trend-up">
            <i class="bi bi-arrow-up"></i>
            +1.8% vs mes anterior
        </div>
    </div>
</div>

<!-- Insights IA -->
<div class="insight-card">
    <div class="insight-icon">
        <i class="bi bi-lightbulb"></i>
    </div>
    <div class="insight-title">游눠 Insight del Sistema de IA</div>
    <div class="insight-text">
        Las m치quinas CNC muestran un patr칩n de mantenimiento m치s eficiente cuando se programan durante las primeras horas del d칤a. 
        Considere reprogramar 3 칩rdenes de mantenimiento para optimizar la eficiencia en un 12%.
    </div>
</div>

<!-- Gr치ficos y Visualizaciones -->
<div class="row">
    <!-- Eficiencia por Tiempo -->
    <div class="col-lg-8 mb-4">
        <div class="report-card">
            <div class="report-card-header">
                <div>
                    <h5 class="report-title">
                        <i class="bi bi-graph-up text-primary"></i>
                        Eficiencia Operativa
                    </h5>
                    <p class="report-subtitle">Tendencia de eficiencia en los 칰ltimos 30 d칤as</p>
                </div>
            </div>
            <div class="report-card-body">
                <div class="chart-container">
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Distribuci칩n de Estados -->
    <div class="col-lg-4 mb-4">
        <div class="report-card">
            <div class="report-card-header">
                <div>
                    <h5 class="report-title">
                        <i class="bi bi-pie-chart text-success"></i>
                        Estado de M치quinas
                    </h5>
                    <p class="report-subtitle">Distribuci칩n actual</p>
                </div>
            </div>
            <div class="report-card-body">
                <div class="progress-ring-container">
                    <svg class="progress-ring" viewBox="0 0 160 160">
                        <circle class="background" cx="80" cy="80" r="70"></circle>
                        <circle class="progress" cx="80" cy="80" r="70" 
                                style="stroke: #28a745; stroke-dashoffset: 110;" id="operativeProgress"></circle>
                    </svg>
                    <div class="progress-text">
                        <div class="progress-value">75%</div>
                        <div class="progress-label">Operativas</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Costos de Mantenimiento -->
    <div class="col-lg-6 mb-4">
        <div class="report-card">
            <div class="report-card-header">
                <div>
                    <h5 class="report-title">
                        <i class="bi bi-bar-chart text-info"></i>
                        Costos por Categor칤a
                    </h5>
                    <p class="report-subtitle">Distribuci칩n de gastos de mantenimiento</p>
                </div>
            </div>
            <div class="report-card-body">
                <div class="chart-container">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tiempo de Resoluci칩n -->
    <div class="col-lg-6 mb-4">
        <div class="report-card">
            <div class="report-card-header">
                <div>
                    <h5 class="report-title">
                        <i class="bi bi-speedometer2 text-warning"></i>
                        Tiempo de Resoluci칩n
                    </h5>
                    <p class="report-subtitle">Promedio por tipo de mantenimiento</p>
                </div>
            </div>
            <div class="report-card-body">
                <div class="chart-container">
                    <canvas id="resolutionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Datos Detallados -->
<div class="row">
    <div class="col-12">
        <div class="data-table">
            <div class="table-header">
                <h5 class="table-title">游늶 Detalle de M치quinas por Rendimiento</h5>
                <div class="table-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshTable()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="exportTable()">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Estado</th>
                            <th>C칩digo</th>
                            <th>M치quina</th>
                            <th>Eficiencia</th>
                            <th>Tiempo Activo</th>
                            <th>Costo Mensual</th>
                            <th>칔ltimo Mantenimiento</th>
                            <th>Tendencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <span class="status-indicator status-success"></span>
                                Operativa
                            </td>
                            <td><strong>TOR-001</strong></td>
                            <td>Torno CNC Siemens 840D</td>
                            <td>92.5%</td>
                            <td>156h</td>
                            <td>$245,000</td>
                            <td>Hace 5 d칤as</td>
                            <td><canvas class="sparkline" data-sparkline="85,90,88,92,89,92,95"></canvas></td>
                        </tr>
                        <tr>
                            <td>
                                <span class="status-indicator status-warning"></span>
                                Mantenimiento
                            </td>
                            <td><strong>FRE-002</strong></td>
                            <td>Fresadora Universal Huron</td>
                            <td>78.2%</td>
                            <td>98h</td>
                            <td>$189,500</td>
                            <td>En proceso</td>
                            <td><canvas class="sparkline" data-sparkline="88,85,82,78,75,78,82"></canvas></td>
                        </tr>
                        <tr>
                            <td>
                                <span class="status-indicator status-success"></span>
                                Operativa
                            </td>
                            <td><strong>SOL-003</strong></td>
                            <td>Equipo Soldadura MIG/MAG</td>
                            <td>89.7%</td>
                            <td>142h</td>
                            <td>$156,800</td>
                            <td>Hace 2 d칤as</td>
                            <td><canvas class="sparkline" data-sparkline="92,89,91,88,89,90,92"></canvas></td>
                        </tr>
                        <tr>
                            <td>
                                <span class="status-indicator status-success"></span>
                                Disponible
                            </td>
                            <td><strong>TAL-004</strong></td>
                            <td>Taladro de Banco</td>
                            <td>95.1%</td>
                            <td>67h</td>
                            <td>$78,200</td>
                            <td>Hace 12 d칤as</td>
                            <td><canvas class="sparkline" data-sparkline="93,95,94,96,95,94,95"></canvas></td>
                        </tr>
                        <tr>
                            <td>
                                <span class="status-indicator status-danger"></span>
                                Reparaci칩n
                            </td>
                            <td><strong>COM-005</strong></td>
                            <td>Compresor Industrial</td>
                            <td>45.8%</td>
                            <td>23h</td>
                            <td>$298,700</td>
                            <td>Hace 15 d칤as</td>
                            <td><canvas class="sparkline" data-sparkline="78,65,58,45,38,42,46"></canvas></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    initializeSparklines();
    animateKPIs();
    startRealTimeUpdates();
});

function initializeCharts() {
    // Gr치fico de Eficiencia
    const effCtx = document.getElementById('efficiencyChart').getContext('2d');
    new Chart(effCtx, {
        type: 'line',
        data: {
            labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
            datasets: [{
                label: 'Eficiencia (%)',
                data: [82, 85, 89, 87],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0,123,255,0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 75,
                    max: 95,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            elements: {
                point: {
                    hoverRadius: 8
                }
            }
        }
    });
    
    // Gr치fico de Costos
    const costCtx = document.getElementById('costChart').getContext('2d');
    new Chart(costCtx, {
        type: 'bar',
        data: {
            labels: ['CNC', 'Fresadoras', 'Soldadura', 'Neum치tica', 'Hidr치ulica'],
            datasets: [{
                label: 'Costo (Miles COP)',
                data: [850, 620, 430, 290, 180],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(108, 117, 125, 0.8)'
                ],
                borderColor: [
                    '#28a745',
                    '#17a2b8',
                    '#ffc107',
                    '#dc3545',
                    '#6c757d'
                ],
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // Gr치fico de Tiempo de Resoluci칩n
    const resCtx = document.getElementById('resolutionChart').getContext('2d');
    new Chart(resCtx, {
        type: 'radar',
        data: {
            labels: ['Preventivo', 'Correctivo', 'Predictivo', 'Emergencia', 'Overhaul'],
            datasets: [{
                label: 'Tiempo Promedio (horas)',
                data: [2, 6, 1.5, 8, 24],
                borderColor: '#ff6b6b',
                backgroundColor: 'rgba(255, 107, 107, 0.2)',
                borderWidth: 2,
                pointBackgroundColor: '#ff6b6b',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 25,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

function initializeSparklines() {
    const sparklines = document.querySelectorAll('.sparkline');
    sparklines.forEach(canvas => {
        const data = canvas.dataset.sparkline.split(',').map(Number);
        const ctx = canvas.getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((_, i) => i),
                datasets: [{
                    data: data,
                    borderColor: data[data.length - 1] > data[0] ? '#28a745' : '#dc3545',
                    borderWidth: 1.5,
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                elements: {
                    point: { radius: 0 }
                }
            }
        });
    });
}

function animateKPIs() {
    const kpiValues = [
        { id: 'efficiencyValue', value: 87.5, suffix: '%', duration: 2000 },
        { id: 'costValue', value: 2.4, suffix: 'M', prefix: '$', duration: 2500 },
        { id: 'downtimeValue', value: 2.1, suffix: 'h', duration: 2200 },
        { id: 'satisfactionValue', value: 94.2, suffix: '%', duration: 2800 }
    ];
    
    kpiValues.forEach(kpi => {
        animateValue(kpi.id, 0, kpi.value, kpi.duration, kpi.prefix, kpi.suffix);
    });
}

function animateValue(id, start, end, duration, prefix = '', suffix = '') {
    const element = document.getElementById(id);
    const startTime = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = start + (end - start) * easeOut;
        
        element.textContent = prefix + current.toFixed(1) + suffix;
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

function toggleExportMenu() {
    const menu = document.getElementById('exportMenu');
    menu.classList.toggle('show');
    
    // Close on click outside
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            if (!e.target.closest('.export-dropdown')) {
                menu.classList.remove('show');
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 100);
}

function exportReport(format) {
    const button = document.querySelector('.export-btn');
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Exportando...';
    button.disabled = true;
    
    // Simulate export
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        
        if (typeof showSuccess !== 'undefined') {
            showSuccess('Exportaci칩n Completada', `Reporte exportado en formato ${format.toUpperCase()}`);
        } else {
            alert(`Reporte exportado en formato ${format.toUpperCase()}`);
        }
    }, 2000);
    
    document.getElementById('exportMenu').classList.remove('show');
}

function applyFilters() {
    const period = document.getElementById('periodFilter').value;
    const center = document.getElementById('centerFilter').value;
    const category = document.getElementById('categoryFilter').value;
    
    // Show loading state
    const cards = document.querySelectorAll('.report-card');
    cards.forEach(card => {
        card.style.opacity = '0.6';
        card.style.pointerEvents = 'none';
    });
    
    // Simulate filter application
    setTimeout(() => {
        cards.forEach(card => {
            card.style.opacity = '1';
            card.style.pointerEvents = 'auto';
        });
        
        // Update charts with filtered data
        updateChartsWithFilters(period, center, category);
        
        if (typeof showInfo !== 'undefined') {
            showInfo('Filtros Aplicados', 'Los reportes han sido actualizados con los nuevos criterios');
        }
    }, 1500);
}

function updateChartsWithFilters(period, center, category) {
    // This would update charts with new filtered data
    console.log('Updating charts with filters:', { period, center, category });
    
    // Animate KPIs again with new values
    setTimeout(() => {
        animateKPIs();
    }, 500);
}

function refreshTable() {
    const tableBody = document.querySelector('.modern-table tbody');
    const originalContent = tableBody.innerHTML;
    
    // Show loading state
    tableBody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4">
                <i class="bi bi-hourglass-split me-2"></i>
                Actualizando datos...
            </td>
        </tr>
    `;
    
    // Simulate refresh
    setTimeout(() => {
        tableBody.innerHTML = originalContent;
        initializeSparklines(); // Reinitialize sparklines
    }, 1000);
}

function exportTable() {
    if (typeof showSuccess !== 'undefined') {
        showSuccess('Tabla Exportada', 'Los datos de la tabla han sido exportados a Excel');
    } else {
        alert('Tabla exportada exitosamente');
    }
}

function startRealTimeUpdates() {
    // Update data every 30 seconds
    setInterval(() => {
        updateRealTimeData();
    }, 30000);
}

function updateRealTimeData() {
    // Simulate real-time data updates
    const updates = [
        { id: 'efficiencyValue', change: (Math.random() - 0.5) * 2 },
        { id: 'costValue', change: (Math.random() - 0.5) * 0.2 },
        { id: 'downtimeValue', change: (Math.random() - 0.5) * 0.5 },
        { id: 'satisfactionValue', change: (Math.random() - 0.5) * 1 }
    ];
    
    updates.forEach(update => {
        const element = document.getElementById(update.id);
        if (element) {
            const currentValue = parseFloat(element.textContent.replace(/[^\d.]/g, ''));
            const newValue = Math.max(0, currentValue + update.change);
            
            // Highlight the change
            element.parentElement.style.transition = 'all 0.3s ease';
            element.parentElement.style.transform = 'scale(1.05)';
            element.parentElement.style.background = 'rgba(0,123,255,0.1)';
            
            setTimeout(() => {
                element.parentElement.style.transform = 'scale(1)';
                element.parentElement.style.background = '';
            }, 500);
        }
    });
}

// Initialize progressive ring animation
function initializeProgressRing() {
    const progress = document.getElementById('operativeProgress');
    const circumference = 2 * Math.PI * 70;
    const offset = circumference - (75 / 100) * circumference;
    
    setTimeout(() => {
        progress.style.strokeDashoffset = offset;
    }, 500);
}

// Call after DOM is loaded
setTimeout(initializeProgressRing, 1000);
</script>
{% endblock %}